<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- STYLES (last overrides previous)-->
    <!-- <link rel="stylesheet" href="css/font-awesome-all.css" type="text/css"> -->
    <link rel="stylesheet" href="css/normalize.css" type="text/css">
    <link rel="stylesheet" type="text/css" href="css/bootstrap.css"><!-- more themes on bootswatch: -->
    <!-- my own definitions: -->
    <link rel="stylesheet" type="text/css" href="css/dark.css">


  <link href="css/c3.css" rel="stylesheet" type="text/css">

</head>

<body class="">

    <div class="header-top-area">
        <div class="container-fluid">
            <div class="row justify-content-between align-items-start">

                <div class="col-xs-auto">
                    <div id="sidebarCollapse" class="navbar-toggler" type="button">
                        <!-- <span class="navbar-toggler-icon"></span> -->
                        <i class="fas fa-bars fa-2x"></i>
                    </div>
                </div>

                <div class="col">
                </div>

                <div class="datetime-area col-md-3 col-xs-6 d-none d-sm-block text-center">
                    <div id="current-time" class="h2 text-light d-inline"></div>
                    <div id="current-date"></div>
                </div>
                <!-- hide time and weather in mobile -->
                <div class="weather-area col-md-auto d-none d-md-block text-center">
                    <i class="fas fa-fw fa-2x fa-sun d-inline"></i>
                    <div class="weather-temperature h2 text-light d-inline">23 C</div>
                    <div id="weather-text">bit crap in the mornings</div>

                    <!-- <script type='text/javascript'
                        src='https://darksky.net/widget/default-small/21.9745,113.9314/uk12/en.js?width=100%&height=70&title=Full Forecast&textColor=ffffff&bgColor=transparent&transparency=true&skyColor=undefined&fontFamily=Default&customFont=&units=uk'></script> -->

                </div>

                <div class="col">
                </div>

            </div>
        </div>
    </div>
    
    <!-- progress bars etc -->
    <div class="status-area bg-dark d-none">
        <div class="progress bg-dark" style="height: 15px;">
            <!-- add some js -->
            <!-- $('.progress-bar').css('width', valeur+'%').attr('aria-valuenow', valeur -->
            <!-- http://www.minddust.com/project/bootstrap-progressbar/demo/bootstrap-3-3-4/#h-default -->
            <!-- https://www.uibootstrap.net/bootstrap-css/progress-bar-circle-for-steps-using-bootstrap/ -->
            <div class="progress-bar bg-info" role="progressbar" style="width: 30%;" aria-valuenow="30" aria-valuemin="0"
                aria-valuemax="100">30%
            </div>
        </div>
    </div>

    <div class="wrapper">

        <!-- Sidebar  -->
        <nav id="sidebar" class="text-light pt-3">
                <!-- https://bootstrapious.com/p/bootstrap-sidebar -->

            <div id="accordionTOP" class="h-100">
                <ul class="list-unstyled my-0">

                    <li class="nav-item py-2" data-toggle="collapse" data-target="#userinfo-area" aria-expanded="false" aria-controls="userinfo-area">
                        <i class="fas fa-2x fa-fw fa-user"></i>  
                        <div id="user" class="d-inline">none</div> 
                        <i class="fas fa-fw fa-sort-down float-right mt-2"></i>
                    </li>
                    <div id="userinfo-area" class="collapse" data-parent="#accordionTOP">
                        <ul class="list-unstyled py-2">
                            <li class="py-2"><i class="fas fa-fw fa-info"></i>Notifications
                                <div class="rounded float-right bg-dark warning mx-1 px-1">3</div>
                            </li>
                            <li class="py-2"><i class="fas fa-fw fa-envelope"></i>Mail
                                <div class="rounded float-right bg-dark warning mx-1 px-1">3</div>
                            </li>
                        </li>
                    </div>


                    <li class="nav-item py-2" data-toggle="collapse" data-target="#serverinfo-area" aria-expanded="false" aria-controls="serverinfo-area">
                        <i class="fas fa-fw fa-network-wired"></i>  server
                        <div id="server" class="d-inline">connecting..</div> 
                        <i class="fas fa-fw fa-sort-down float-right mt-2"></i>
                    </li>
                    <div id="serverinfo-area" class="collapse" data-parent="#accordionTOP">
                        <ul class="list-unstyled py-2">
                            <li class="py-2"><i class="fas fa-fw fa-clock"></i>Uptime: <div class="d-inline" id="server-uptime"> 1d 2:32:06</div></li>
                            <li class="py-2"><i class="fas fa-fw fa-circle-notch fa-spin"></i>TX:</li>
                            <li class="py-2"><i class="fas fa-fw fa-circle-notch fa-spin"></i>RX:</li>
                            
                        </ul>
                    </div>
                </ul>
                <ul class="list-unstyled border-bottom border-dark">
                    <li class="nav-item"><a class="nav-link" value="dashboard" href="#dashboard"><i class="fas fa-fw fa-tachometer-alt"></i>Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" value="charts" href="#charts"><i class="fas fa-fw fa-chart-line"></i>Charts</a></li>
                    <li class="nav-item"><a class="nav-link" value="settings" href="#settings"><i class="fas fa-fw fa-cog fa-spin"></i>Settings</a></li>
                    <li class="nav-item"><a class="nav-link" value="log" href="#log"><i class="fas fa-fw fa-list-ol"></i>Log</a></li>
                    <li class="nav-item"><a class="nav-link" value="weather" href="#weather"><i class="fas fa-fw fa-sun"></i>Weather</a></li>
                </ul>
                
                <ul class="list-unstyled">
                    <li class="nav-item py-2" data-toggle="collapse" data-target="#sidebar-settings-area" aria-expanded="false"
                        aria-controls="userinfo-area">
                        <i class="fas fa-fw fa-user-cog"></i>Options
                        <i class="fas fa-fw fa-sort-down float-right mt-2"></i>
                    </li>
                    <div id="sidebar-settings-area" class="collapse clearfix" data-parent="#accordionTOP">
                        <div class="d-inline py-2">INTERVAL: </div><div class="d-inline" id="interval"></div>
                        <div class="form-inline interval-control py-2">
                            <!-- hide the buttons when disconnected -->
                            <input type="button" class="btn btn-primary btn-sm" value="STOP" onclick='disconnect();'>
                            <input type="button" class="btn btn-primary btn-sm" value="START" onclick='connect();'>
                            <input type="button" class="btn btn-primary btn-sm" value="0.3" onclick='sendText("interval", 0.3);'>
                            <input type="button" class="btn btn-primary btn-sm" value="0.5" onclick='sendText("interval", 0.5);'>
                            <input type="button" class="btn btn-primary btn-sm" value="1" onclick='sendText("interval", 1);'>
                        </div>
                        <button type="button" class="btn btn-primary btn-sm float-right" data-toggle="modal"
                            data-target="#exampleModalCenter"> SAVE</button>
                    </div>
                </ul>
            </div>

        </nav>

        <!-- Page Content  -->
        <div id="content"class="content-area container-fluid pt-3 px-3 bg-dark text-light">

            <div id="dashboard" style="display: none">
                    <!-- https://demos.creative-tim.com/black-dashboard/examples/dashboard.html -->
                <div class="row">
                    <div class="col-sm">

                        <div class="card bg-primary" id="greenhouse1-temp1">
                            <div class="card-header">
                                <i class="fas fa-temperature-low"></i>
                                <div id="dash-panel-name" class="d-inline">name</div>
                            </div>
                            <div class="card-body">
                                <!-- <div class="card-title">
                                    <i class="fas fa-temperature-low"></i>
                                    <div id="dash-panel-name">name</div>
                                </div> -->
                                <H1 class="card-text text-light" id="panel_value">XX</H1>
                            </div>
                        </div>
                    </div>


                    <div class="col-sm">
                        <div class="card bg-primary" id="greenhouse1-humidity">
                            <div class="card-header">
                                <i class="fas fa-temperature-low"></i>
                                <div id="dash-panel-name" class="d-inline">name</div>
                            </div>
                            <div class="card-body">
                                <H1 class="card-text text-light" id="panel_value">XX</H1>
                            </div>                     
                        </div>
                    </div>
                </div>
            </div>
    
            <div id="log" style="display: none">
                <!-- LOG SHOULD READ FROM DB NOT WS -->
                <!-- THEN APPEND NEW DATA BASED ON TIMESTAMP -->
                <div class="row">
                    <div class="col">
                        <table id="logtable" class="table table-hover table-striped table-sm table-dark">
                            <thead class="thead-dark">
                                <tr>
                                    <th scope="col">Time</th>
                                    <th scope="col">Category</th>
                                    <th scope="col">Key</th>
                                    <th scope="col">Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- table rows get added here -->
                            </tbody>
                        </table>
                    </div>
    
                </div>
            </div>

            <div id="charts" style="display: none">
                <div class="row">
                    <div class="col text-danger">
                        <!-- <H1>Charts</H1> -->
                        

                        <!-- <canvas id="myChartz"></canvas> -->
                        <div id="c3chart">hmm</div>
                        
                        <!-- 
                        https://www.chartjs.org/docs/latest/
                        http://nagix.hatenablog.com/entry/2017/07/11/004952
                        https://colorlib.com/polygon/gentelella/other_charts.html

                        https://stackoverflow.com/questions/29614365/websocket-data-to-update-chartjs-chart -->

                        <!-- https://medium.com/@benjaminmbrown/real-time-data-visualization-with-d3-crossfilter-and-websockets-in-python-tutorial-dba5255e7f0e -->
                        <!-- https://stackoverflow.com/questions/34578507/d3js-chart-update-triggered-on-websocket-message -->
                        <!-- https://github.com/mdrilwan/dashboard/tree/master/WebContent/js -->



                    </div>
                </div>
            </div>

            <div id="weather" style="display: none">
                <div class="row">
                    <div class="col">
                        <H1>Weather</H1>
                        <H3>It's all good, no worries</H3>

                        <!-- https://www.programmableweb.com/news/top-10-weather-apis/analysis/2014/11/13 -->

                        <!-- https://www.weather.gov/documentation/services-web-api -->
                        <!-- https://developer.accuweather.com -->
                        <!-- http://www.bom.gov.au/catalogue/data-feeds.shtml -->

                        <!-- https://openweathermap.org/appid

                        {"coord":{"lon":139,"lat":35},
                        "sys":{"country":"JP","sunrise":1369769524,"sunset":1369821049},
                        "weather":[{"id":804,"main":"clouds","description":"overcast clouds","icon":"04n"}],
                        "main":{"temp":289.5,"humidity":89,"pressure":1013,"temp_min":287.04,"temp_max":292.04},
                        "wind":{"speed":7.31,"deg":187.002},
                        "rain":{"3h":0},
                        "clouds":{"all":92},
                        "dt":1369824698,
                        "id":1851632,
                        "name":"Shuzenji",
                        "cod":200} -->


                        <!-- <script type='text/javascript'
                            src='https://darksky.net/widget/graph/42.360082,-71.05888/si12/en.js?width=100%&height=320&title=Full Forecast&textColor=ffffff&bgColor=000000&transparency=true&fontFamily=Default&customFont=&units=si&graph=temperature_graph&timeColor=ffffff&tempColor=ffffff&lineColor=dddddd&markerColor=ffffff'></script> -->
    

                            <!-- crowdsource my weather option (select sensors) -->
                    </div>
                </div>
            </div>

            <div id="calendar" style="display: none">
                <div class="row">
                    <div class="col">
                        <H1>Calendar</H1>
                        <H3>It's all good, no worries</H3>
                        https://momentjs.com/
                    </div>
                </div>
            </div>

            <div id="settings" style="display: none">
                <div class="row">
                    <div class="col">
                        <H1>DEVICES | SENSORS | USER | SERVER | OTHER</H1>
                        <br>

                        <form class="needs-validation" novalidate>
                            <div class="form-group">
                                <div class="form-radio">
                                    <input class="form-radio-input" type="radio" id="gridCheck1">
                                    <label class="form-check-label" for="gridCheck1">
                                        Add new device
                                    </label>
                                    <input class="form-radio-input" type="radio" id="gridCheck">
                                    <label class="form-check-label" for="gridCheck">
                                        Modify added device
                                    </label>
                                </div>
                            </div>
                        
                            <div class="form-group">
                                <label for="inputCity">Name</label>
                                <input type="text" class="form-control bg-black" id="inputCity">
                        
                                <select id="inputState" class="form-control bg-black">
                                    <option selected>Arduino</option>
                                    <option>ESP</option>
                                    <option>STM</option>
                                </select>
                                <small id="passwordHelpInline" class="text-muted">
                                    Must be unique. Must contain only letters, numbers, dash
                                </small>
                                <div class="valid-feedback">
                                    Looks good!
                                </div>
                            </div>
                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label for="iface">Type</label>
                                    <select id="inputState" class="form-control">
                                        <option selected>Arduino</option>
                                        <option>ESP</option>
                                        <option>STM</option>
                                    </select>
                                    <div class="valid-feedback">
                                        Looks good!
                                    </div>
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="inputEmail4">Subcat</label>
                                    <select id="inputState" class="form-control">
                                        <option selected>NANO</option>
                                        <option>UNO</option>
                                        <option>MEGA</option>
                                    </select>
                                    <div class="valid-feedback">
                                        Looks good!
                                    </div>
                                </div>
                            </div>
                        
                            <div class="form-row">
                                <div class="form-group col-md-6">
                                    <label for="inputEmail4">Interface</label>
                                    <select id="inputState" class="form-control">
                                        <option selected>USB</option>
                                        <option>WIFI</option>
                                        <option>ETH</option>
                                    </select>
                                    <div class="valid-feedback">
                                        Looks good!
                                    </div>
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="inputCity">IP Address</label>
                                    <input type="text" class="form-control" id="inputCity">
                                    <div class="valid-feedback">
                                        Looks good!
                                    </div>
                                </div>
                            </div>
                        
                            <div class="form-row">
                                <div class="form-group col-md-2">
                                    <label for="inputState">Icon</label>
                                    <select id="inputState" class="form-control">
                                        <option selected>Choose...</option>
                                        <option>...</option>
                                    </select>
                                </div>
                                <div class="form-group col-md-2">
                                    <label for="inputZip">color</label>
                                    <input type="text" class="form-control" id="inputZip">
                                </div>
                            </div>
                        
                            <button type="submit" class="btn btn-primary">Validate</button>
                            <button type="submit" class="btn btn-primary">Save</button>
                        </form>

                        <br>


                       
                        
    <!-- 
         https://getbootstrap.com/docs/4.0/components/forms/
                        - **add/change Device**
                        - device name (new or dropdown)
                        - select interface (dropdown)
                          - USB
                            - port?
                          - WIFI
                            - ip address
                          - ETHERNET
                            - ip address
                        - Device type (dropdown)
                          - arduino (dropdown)
                          - NodeMCU
                          - stm32
                          - raspberry pi





                      - **add/change SENSOR**
                        - connected to device name (dropdown of existing)
                        - Name(new or dropdown)
                        - type of sensor
                          - temp
                          - humid
                          - ...
                        - interface (pins)
                          - Analog
                          - digital
                          - SPI
                          - address
                          - I2C
                            - address
                          - onewire
                            - address -->
                    </div>
                </div>
            </div>

        </div>
        
    </div>

    <!-- Modals -->
    <div class="modal fade" id="exampleModalCenter" tabindex="-1" role="dialog"
        aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle">Modal title</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    ...
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" data-dismiss="modal">Save changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- https://bootstrapious.com/p/bootstrap-sidebar -->
    <!-- https://mladenplavsic.github.io/bootstrap-navbar-sidebar/ -->

    <!-- JAVASCRIPTS -->
    <script src="js/jquery-3.4.0.js"></script>
    <script src="js/bootstrap.js"></script>
    <script src="js/Chart.min.js"></script>
    <script defer src="js/fa-all.js"></script>
    <script src="js/d3.v5.min.js"></script>
    <script src="js/c3.min.js" type="text/javascript"></script>

    <script type="text/javascript">
        //defaults
        var username = "index-v4";
        var defaultInterval = 1;
        var homepage = "dashboard";
        var nodata = "No data"

        // runtime vars:
        var JSONfromSRVR = null;
        var socket = null;
        var isopen = false;


        var chartdata = [['x'] ['temp1', 0],['humid1',0]];
        var chart = c3.generate({
                    bindto: '#c3chart',
                    size: {
                        height: 400,
                        width: 1000
                    },
                    data: {
                        x: 'x',
                        columns:
                            chartdata              
                    },
                    axis: {
                        x: {
                            type: 'timeseries',
                            // tick: {
                            //     format: '%Y-%m-%d'
                            // }
                        }
                    }
                }); 
                // chart.hide(['data1']);
        

        // socket = new WebSocket("ws://127.0.0.1:9000");
        socket = new WebSocket("ws://192.168.1.101:9000");

        // main functions:
        window.onload = function () {
            updateClock();
            setInterval('updateClock()', 1000);
            $(".interval-control .btn[value='STOP'").hide();
            $("#dashboard .card-body .card-text").text(nodata);
        };

        function navigate(page) { // hide all content, then show the one and set it active
            //hide all content
            $(".content-area").children().hide();
            $("#sidebar .nav-link").removeClass("active"); //set all inactive
            $(".nav-link[value='" + page + "']").addClass("active");
            $("#" + page).fadeIn(); //show one page
        }

        $(document).ready(function () {
            var thisURL = $(location).attr('href');
            var URLparts = thisURL.split('#');
            if (URLparts[1]) { homepage = URLparts[1] };
            $("#user").text(username);
            navigate(homepage);
            $("#sidebar .nav-item a").click(function () {       // mainmenu page switch
                var page = $(this).attr('value'); //get pagename
                navigate(page);
                
                // $("#sidebar").toggleClass('active');
                    // c3 d3
                    
            });
            $(".datetime-area").click(function () {             // clicked on the top clock
                navigate("calendar");
            });
            $(".weather-area").click(function () {              // clicked on top weather
                navigate("weather");
            });
            $('#sidebarCollapse').on('click', function () {     //sidebar hide show
                $('#sidebar').toggleClass('active');
            });

            senddefaults();         // send info tu server. (server should get this from DB)
        });

        window.onclose = function () {
            disconnect();
        };

        socket.onopen = function () {
            console.log("Connected!");
            $("#server").text("ONLINE");
            isopen = true;
            sendText("username", username); // simple authentication / id of user
            // $("#user").text(username);
            $("#server").text("LIVE");
            $("#accordionTOP .fa-network-wired").toggleClass("success")
            $(".interval-control .btn[value='STOP'").show();
            $(".interval-control .btn[value='START'").hide();

        };

        socket.onmessage = function (e) {
            var now = new Date();
            var time_now = now.toLocaleTimeString()
            //console.log("RX: " + e.data);
            var JSONfromSRVR = JSON.parse(e.data) // parse string to object
            for (var datatype in JSONfromSRVR) { // start sinking into json object: get datatype (reading)
                //console.log("-type:"+datatype);
                for (var subcat = 0; subcat < JSONfromSRVR[datatype].length; subcat++) { //iterate over array of subcategories
                    for (var subcatname in JSONfromSRVR[datatype][subcat]) { //get name of subcategory (greenhouse)
                        var dataarray = JSONfromSRVR[datatype][subcat][subcatname]; //get value array of subcategory 
                        //console.log("--"+subcatname); // name of subcategory
                        for (var cell = 0; cell < dataarray.length; cell++) { //iterate over each cell (temp1:300)
                            var jkey = dataarray[cell].name;
                            var jval = dataarray[cell].value;
                            // console.log("---data: "+jkey+":"+jval); // name of value in subcategory
                            // take actions based on [datatype]
                            if (datatype == "reading") {
                                var panelname = subcatname + "-" + jkey;
                                $("#" + panelname + " #dash-panel-name").text(jkey);
                                $("#" + panelname + " .card-body .card-text").text(jval);
                                // show subcatname?

                                // chartdata[0].push(time_now);
                                // chartdata[cell].push(jval);
                                // chartdata.splice(1, 1);      //remove 2nd element
                                
                                chart.load({
                                    columns: chartdata
                                });
                                // console.log(chartdata);

                                

                            } else if (datatype == "setting") {
                                $("#interval").text(jval + "s ");
                                // } else if (datatype == "alert"){
                                div_log_row = '<tr><th scope="row">' + time_now + '</th><td>' + datatype + '</td><td>' + jkey + '</td><td>' + jval + '</td></tr>'
                                // $("#logtable").append(div_log_row);
                                $("#logtable tbody").prepend(div_log_row);
                            }
                        }
                    }
                }
            }
        };
        

        // socket.onerror = function (e){alert("socket error")};
        socket.onclose = function (e) {
            console.log("Connection closed.");
            socket = null;
            isopen = false;
            $("#accordionTOP .fa-network-wired").toggleClass("warning")
            $("#server").text("OFFLINE");
            $(".interval-control .btn[value='STOP'").hide();
            $(".interval-control .btn[value='START'").show();
        };

        function senddefaults() {
            sendText("interval", defaultInterval); //et the default interval
            $(".interval-control .btn[value='" + defaultInterval + "'").addClass("active");
        }

        function disconnect() {
            socket.close();
        };

        function connect() {
            location.reload();
        };

        function sendText(key, value) {
            if (isopen) {
                jsonstring = JSON.stringify({
                    [key]: value
                }) // [] needed to avoid taking "key literally"
                socket.send(jsonstring);
                console.log("TX: " + jsonstring);
            } else {
                console.log("Connection not opened.")
            }
        };

        function updateClock() {
            var now = new Date();
            $("#current-time").text(now.toLocaleTimeString());
            $("#current-date").text(now.toDateString());
        }


    // chart.js

        // var ctx = $('#myChart');
        // var chart = new Chart(ctx, {
        //     // The type of chart we want to create
        //     type: 'line',

        //     // The data for our dataset
        //     data: {
        //         labels: ['January', 'February', 'March', 'April', 'May', 'June', 'July'],
        //         datasets: [{
        //             label: 'My First dataset',
        //             backgroundColor: 'rgb(255, 99, 132)',
        //             borderColor: 'rgb(255, 99, 132)',
        //             data: [0, 10, 5, 2, 20, 30, 45]
        //         }]
        //     },
        //     // Configuration options go here
        //     options: {}
        // });



            
    </script>
</body>

</html>