<!DOCTYPE html>
<html>
   <head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

      <!-- STYLES -->
      <link rel="stylesheet" type="text/css"href="css/dark.css">
      <link rel="stylesheet" type="text/css"href="https://necolas.github.io/normalize.css/8.0.1/normalize.css">

      <!-- JAVASCRIPTS -->
      <script src="http://code.jquery.com/jquery-3.4.0.js"></script>
      <script type="text/javascript">
         var socket = null;
         var isopen = false;
         var username = "josh";
         socket = new WebSocket("ws://127.0.0.1:9000");

         // significant html objects:
         var dashboard = null;
         var interval_field = null;
         var server_field = null;

         // runtime vars:
         var JSONfromSRVR = null;

         // main functions:
         window.onload = function(){
            
            username_field = document.getElementById('user');
            server_field = document.getElementById('server');
            interval_field = document.getElementById('interval');
            dashboard = document.getElementById('dashboard');
            log = document.getElementById('log');
            server_field.innerText = "TRYING..";
            updateClock(); 
            setInterval('updateClock()', 1000 );
         };

         window.onclose = function(){disconnect();};
         
         socket.onopen = function() {
            console.log("Connected!");
            server_field.innerText = "ONLINE";
            isopen = true;
            sendText("username", username); // simple authentication / id of user
            username_field.innerText = username;
            server_field.className = "success";
            server_field.innerText = "LIVE";
         };

         socket.onmessage = function(e) {
            //console.log("RX: " + e.data);
            var JSONfromSRVR = JSON.parse(e.data) // parse string to object
            for (var datatype in JSONfromSRVR){  // start sinking into json object: get datatype (reading)
               //console.log("-type:"+datatype);
               for(var subcat = 0; subcat < JSONfromSRVR[datatype].length; subcat++){  //iterate over array of subcategories
                  for(var subcatname in JSONfromSRVR[datatype][subcat]){               //get name of subcategory (greenhouse)
                     var dataarray = JSONfromSRVR[datatype][subcat][subcatname];       //get value array of subcategory 
                     //console.log("--"+subcatname); // name of subcategory
                     for(var cell = 0; cell < dataarray.length; cell++){               //iterate over each cell (temp1:300)
                        var jkey = dataarray[cell].name;
                        var jval = dataarray[cell].value;
                        // console.log("---data: "+jkey+":"+jval); // name of value in subcategory
                        // take actions based on [datatype]
                        if (datatype == "reading"){
                           var this_panel = document.getElementById(subcatname+"-"+jkey);
                           this_panel.children[0].innerText = jkey;
                           this_panel.children[1].innerText = jval;
                        } else if (datatype == "setting"){
                           interval_field.innerText = jval+"s ";
                        // } else if (datatype == "alert"){
                           var div_log_row = document.createElement('div');
                           div_log_row.className = "log_row";
                           //div_log_row.innerText = jkey +" - "+ jval
                           div_log_row.innerHTML = '<div class="log_row_name"> >'+jkey+'</div><div class="log_row_val">'+jval+'</div>'
                           log.appendChild(div_log_row);
                        }
                     }
                  }
               }
            }
         };

         socket.onclose = function(e) {
            console.log("Connection closed.");
            socket = null;
            isopen = false;
            server_field.className = "warning";
            server_field.innerText = "OFFLINE";
         };

         function disconnect(){socket.close(); };

         function sendText(key, value) {
            if (isopen) {
               jsonstring = JSON.stringify({[key] : value}) // [] needed to avoid taking "key literally"
               socket.send(jsonstring);
               console.log("TX: "+ jsonstring);               
            } else {
               console.log("Connection not opened.")
            }
         };

         function updateClock(){
            var now = new Date();
            $("#time").text(now.toLocaleTimeString());
            $("#date").text(now.toDateString());
         }  

         function navigation(page){
            $("#"+page).toggle();
            console.log(page+" hidden");
            //button.server_field.className = "active";
         }
      </script>
   </head>


   <body>
      <div class="header">
         <div id="status" class="statusbar">
            <div class="status-left">
               <div class="status-item">
                  <br>
                     <div id="location">Dunedin, Otago</div>
                     <h1><div id="time"></div></h1>
                     <div id="date"></div>
               </div>
               <div class="status-item">
                     <img id="weather-icon" height="50px" width="50px" src="img/storm.png">
                     <div class="weather-temperature">30 C</div>
                     <div id="weather-text">bit crap in the mornings</div>
               </div>
            </div>
            <div class="status-right">
               <div class="status-item">
                  <img height="50px" width="50px" src="img/conn-0.png">
                  <!-- <div class="button" onclick='disconnect();'>CLOSE</div>  -->
                  <h3></h3><div id="server">--</div></h3>         
               </div>
               <div class="status-item">
                     <img height="50px" width="50px" src="img/user.png">
                     <h3><div id="user">asshole</div></h3>
               </div>
            </div>
         </div>
         <nav class="topnav" role="menu">
            <ul>
               <li onclick='navigation("dashboard")'><a data-toggle="tab">DASHBOARD</a></li>
               <li class="active" onclick='navigation("charts")'>CHARTS</li>
               <li onclick='navigation("log")'>LOG</li>
               <li onclick='navigation("settings")'>SETTINGS</li>
            </ul>
            <!-- <div class="tab-content">
                  subcats
            </div> -->
         </nav>
      </div>


      <div class="content">
         <div id="dashboard">
            INTERVAL: <div id="interval"></div> 
            <button onclick='sendText("interval", 0.3);'>0.3</button>
            <button onclick='sendText("interval", 0.5);'>0.5</button>
            <button onclick='sendText("interval", 1);'>1</button>

            <div class="panel" id="greenhouse1-temp1">
               <div class="panel_name" id="panel_name">name</div>
               <div class="panel_value" id="panel_value">XX</div>
            </div>

            <div class="panel" id="greenhouse1-humidity in">
                  <div class="panel_name" id="panel_name">name</div>
                  <div class="panel_value" id="panel_value">XX</div>
            </div>
         </div>

         <div id="log">
            <div class="log" id="log"></div>
         </div>
      </div>



   </body>
</html>